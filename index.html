<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<title>Jaffar ∞ Vision v3 — YOLOv8-Nano</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
*{box-sizing:border-box}html,body{height:100%;margin:0}
body{font-family:Inter,Segoe UI,Arial,sans-serif;background:#0b0f19;color:#e9eefb;overflow:hidden}
#cam{width:100%;max-height:58vh;border-radius:12px;background:#000;display:block}
#overlay{position:absolute;left:0;top:0;pointer-events:none}
.panel{width:min(1100px,94vw);padding:18px;border-radius:16px;background:rgba(255,255,255,.06);
border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(12px);margin:auto;margin-top:24px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
button,select,input[type=range]{background:#1a71ff;color:#fff;border:none;padding:10px 12px;
border-radius:10px;font-weight:600;cursor:pointer}
select{background:#0f1322;border:1px solid rgba(255,255,255,.15);color:#cde3ff}
input[type=range]{width:160px}
.pill{padding:8px 10px;border-radius:10px;background:rgba(255,255,255,.08);
border:1px solid rgba(255,255,255,.12);color:#cde3ff;font-weight:700}
.right{margin-inline-start:auto}
.desc,.debug{margin-top:8px;padding:10px 12px;border-radius:10px}
.desc{background:rgba(10,16,28,.55);border:1px solid rgba(255,255,255,.12)}
.debug{background:rgba(255,100,100,.1);border:1px solid rgba(255,150,150,.25);
font-family:ui-monospace,Consolas,monospace;white-space:pre-wrap;max-height:22vh;overflow:auto}
.stats{background:rgba(100,255,180,.08);border:1px solid rgba(100,255,180,.25);
margin-top:8px;padding:10px 12px;border-radius:10px;font-family:ui-monospace,Consolas,monospace;
white-space:pre-wrap;max-height:22vh;overflow:auto;display:none}
</style>
</head>
<body>
<div class="panel">
<div class="row">
<button id="startBtn">تشغيل الكاميرا</button>
<button id="autoBtn">تلقائي: إيقاف</button>
<button id="snapBtn" style="background:#15b26b">التقاط فوري</button>
<label class="pill">الوثوق <span id="confVal">0.5</span></label>
<input id="conf" type="range" min="0.2" max="0.95" step="0.05" value="0.5">
<select id="backend">
<option value="webgpu">WebGPU</option>
<option value="webgl" selected>WebGL</option>
<option value="wasm">WASM</option>
</select>
<label class="pill"><input id="speak" type="checkbox"> صوت</label>
<label class="pill"><input id="showColor" type="checkbox" checked> ألوان</label>
<button id="statsBtn" class="right">إحصاءات</button>
<span class="pill" id="status">النموذج: جارِ التحميل…</span>
<span class="pill" id="fps">FPS: —</span>
</div>
<div style="position:relative">
<video id="cam" autoplay playsinline muted></video>
<canvas id="overlay"></canvas>
</div>
<div id="desc" class="desc">لا توجد أجسام.</div>
<div id="stats" class="stats"></div>
<div id="dbg" class="debug">Debug log…</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/webgpu/ort.min.js"></script>
<script>
const cam=document.getElementById('cam'),ov=document.getElementById('overlay'),
dbg=document.getElementById('dbg'),desc=document.getElementById('desc'),
statusEl=document.getElementById('status'),fpsEl=document.getElementById('fps'),
conf=document.getElementById('conf'),confVal=document.getElementById('confVal'),
autoBtn=document.getElementById('autoBtn'),snapBtn=document.getElementById('snapBtn'),
startBtn=document.getElementById('startBtn'),backendSel=document.getElementById('backend'),
speakEl=document.getElementById('speak'),showColorEl=document.getElementById('showColor'),
statsBtn=document.getElementById('statsBtn'),statsEl=document.getElementById('stats');
function log(x){dbg.textContent+="\n"+x;dbg.scrollTop=dbg.scrollHeight;console.log(x)}
let session=null,auto=false,rafId=null,nextId=1,tracks=[],frames=0,lastT=performance.now();
const mem=JSON.parse(localStorage.getItem("visionMemory")||"{}");
function saveMem(){localStorage.setItem("visionMemory",JSON.stringify(mem))}
function colorName(r,g,b){const max=Math.max(r,g,b),min=Math.min(r,g,b);
if(max<40)return"أسود";if(min>220)return"أبيض";if(max==min)return"رمادي";
if(r>g+20&&r>b+20)return"أحمر";if(g>r+20&&g>b+20)return"أخضر";
if(b>r+20&&b>g+20)return"أزرق";if(r>180&&g>180&&b<120)return"أصفر";
return"غير محدد";}
function avgColor([x,y,w,h]){const c=document.createElement("canvas");
c.width=w;c.height=h;const ctx=c.getContext("2d",{willReadFrequently:true});
ctx.drawImage(cam,x,y,w,h,0,0,w,h);const d=ctx.getImageData(0,0,w,h).data;
let r=0,g=0,b=0,n=d.length/4;for(let i=0;i<d.length;i+=4){r+=d[i];g+=d[i+1];b+=d[i+2]}
r=Math.round(r/n);g=Math.round(g/n);b=Math.round(b/n);return{r,g,b,name:colorName(r,g,b)}}
function iou(a,b){const[x1,y1,w1,h1]=a,[x2,y2,w2,h2]=b;
const xx1=Math.max(x1,x2),yy1=Math.max(y1,y2),xx2=Math.min(x1+w1,x2+w2),
yy2=Math.min(y1+h1,y2+h2);const inter=Math.max(0,xx2-xx1)*Math.max(0,yy2-yy1);
const ua=w1*h1+w2*h2-inter;return ua>0?inter/ua:0}
function updateTracks(dets,th){const matched=new Set(),newT=[];
for(const t of tracks){let bestI=0,best=-1;
dets.forEach((d,i)=>{if(matched.has(i))return;const v=iou(t.bbox,d.bbox);
if(v>bestI){bestI=v;best=i}});if(bestI>0.25){matched.add(best);
const d=dets[best];const nb=d.bbox.map((v,i)=>.7*t.bbox[i]+.3*v);
newT.push({id:t.id,class:d.class,bbox:nb,score:d.score,miss:0})}
else if(t.miss<2)newT.push({...t,miss:t.miss+1})}
dets.forEach((d,i)=>{if(!matched.has(i)&&d.score>=th)newT.push({id:nextId++,...d,miss:0})});
tracks=newT;return tracks.filter(t=>t.miss==0)}
function drawBoxes(items){const ctx=ov.getContext("2d");
ctx.clearRect(0,0,ov.width,ov.height);ctx.lineWidth=2;ctx.font="14px ui-monospace";
items.forEach(o=>{const[x,y,w,h]=o.bbox;ctx.strokeStyle="rgba(120,180,255,.95)";
ctx.fillStyle="rgba(10,16,28,.75)";ctx.beginPath();ctx.rect(x,y,w,h);ctx.stroke();
let t=`${o.class}${o.color&&showColorEl.checked?"-"+o.color.name:""}(${o.score.toFixed(2)})#${o.id}`;
const tw=ctx.measureText(t).width+8;ctx.fillRect(x,y-20,tw,20);
ctx.fillStyle="#cde3ff";ctx.fillText(t,x+4,y-6)})}
function summarize(items){if(!items.length){desc.textContent="لا توجد أجسام.";return}
const c={};items.forEach(p=>c[p.class]=(c[p.class]||0)+1);
desc.textContent="ملخص: "+Object.entries(c).map(([k,v])=>`${k}:${v}`).join("، ")}
function tickFPS(){frames++;const n=performance.now();
if(n-lastT>1000){fpsEl.textContent="FPS:"+frames;frames=0;lastT=n}}
async function detectOnce(){if(!session)return;const w=cam.videoWidth,h=cam.videoHeight;
ov.width=w;ov.height=h;const can=document.createElement("canvas");
can.width=w;can.height=h;can.getContext("2d").drawImage(cam,0,0,w,h);
const img=can.getContext("2d").getImageData(0,0,w,h);
const t=new ort.Tensor("uint8",img.data,[1,h,w,4]);
const res=await session.run({images:t});
const boxes=res["output0"].data; // YOLOv8 export typical
const th=parseFloat(conf.value);const dets=[];
for(let i=0;i<boxes.length;i+=6){const s=boxes[i+4];
if(s<th)continue;const x=boxes[i],y=boxes[i+1],ww=boxes[i+2],hh=boxes[i+3];
const c=boxes[i+5];dets.push({bbox:[x*w,y*h,ww*w,hh*h],score:s,class:"obj"+Math.round(c)})}
const act=updateTracks(dets,th);
act.forEach(a=>{if(showColorEl.checked)a.color=avgColor(a.bbox);
mem[a.class]=(mem[a.class]||0)+1});saveMem();drawBoxes(act);summarize(act);
if(speakEl.checked&&act.length){const top=act.slice(0,3).map(a=>a.class).join("، ");
const u=new SpeechSynthesisUtterance(top);u.lang="ar";speechSynthesis.cancel();speechSynthesis.speak(u)}
tickFPS()}
function autoLoop(){if(!auto)return;detectOnce().finally(()=>{rafId=requestAnimationFrame(autoLoop)})}
async function pickBackend(){const b=backendSel.value;
await ort.env.wasm.numThreads=navigator.hardwareConcurrency;
await ort.env.set("ORT_WEB_USE_WEBGPU",b==="webgpu");
await ort.env.set("ORT_WEB_USE_WEBGL",b==="webgl");statusEl.textContent="المعالج:"+b}
async function loadModel(){await pickBackend();
session=await ort.InferenceSession.create("models/yolov8n.onnx");
statusEl.textContent="النموذج: جاهز ✅";log("model ready")}
async function startCam(){const s=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480}},audio:false});
cam.srcObject=s;await new Promise(r=>cam.onloadedmetadata=r);cam.play();
ov.width=cam.videoWidth;ov.height=cam.videoHeight;log("Cam:"+cam.videoWidth+"x"+cam.videoHeight)}
startBtn.onclick=startCam;conf.oninput=()=>confVal.textContent=conf.value;
backendSel.onchange=loadModel;snapBtn.onclick=detectOnce;
autoBtn.onclick=()=>{auto=!auto;autoBtn.textContent="تلقائي:"+(auto?"تشغيل":"إيقاف");
if(auto)autoLoop();else cancelAnimationFrame(rafId)};
statsBtn.onclick=()=>{statsEl.style.display=statsEl.style.display==="none"?"block":"none";
statsEl.textContent="إحصاءات:"+JSON.stringify(mem,null,2)};
(async()=>{await loadModel();setTimeout(startCam,500)})();
</script>
</body>
</html>